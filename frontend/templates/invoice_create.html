{% extends 'base.html' %}

{% block title %}Create Invoice - Digital Khata{% endblock %}

{% block extra_js %}
<script src="/static/js/invoice-preview.js"></script>
{% endblock %}

{% block content %}
<div class="py-8">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl md:text-3xl font-bold">Create New Invoice</h1>
    <div class="flex space-x-3">
      <button class="btn btn-outline">
        <i class="bi bi-save mr-2"></i>Save Draft
      </button>
      <button class="btn btn-primary">
        <i class="bi bi-send mr-2"></i>Send Invoice
      </button>
    </div>
  </div>
  
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Invoice Form -->
    <div class="lg:col-span-2">
      <div class="card">
        <div class="card-body">
          <form>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div>
                <label for="customer" class="block text-sm font-medium text-slate-700 mb-1">
                  Customer
                </label>
                <div class="relative">
                  <select id="customer" class="form-control">
                    <option value="">Select a customer</option>
                    <option value="1">Rajesh Kumar</option>
                    <option value="2">Sunita Devi</option>
                    <option value="3">Vikash Singh</option>
                    <option value="4">Priya Sharma</option>
                  </select>
                  <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                    <i class="bi bi-chevron-down text-slate-400"></i>
                  </div>
                </div>
              </div>
              
              <div>
                <label for="invoice_date" class="block text-sm font-medium text-slate-700 mb-1">
                  Invoice Date
                </label>
                <input 
                  type="date" 
                  id="invoice_date" 
                  class="form-control"
                  value="{{ today }}"
                >
              </div>
              
              <div>
                <label for="due_date" class="block text-sm font-medium text-slate-700 mb-1">
                  Due Date
                </label>
                <input 
                  type="date" 
                  id="due_date" 
                  class="form-control"
                >
              </div>
              
              <div>
                <label for="invoice_number" class="block text-sm font-medium text-slate-700 mb-1">
                  Invoice Number
                </label>
                <input 
                  type="text" 
                  id="invoice_number" 
                  class="form-control"
                  value="INV-00126"
                  readonly
                >
              </div>
            </div>
            
            <!-- Items Table -->
            <div class="mb-6">
              <div class="flex justify-between items-center mb-4">
                <h3 class="font-medium">Items</h3>
                <button type="button" id="add-item" class="btn btn-outline btn-sm">
                  <i class="bi bi-plus mr-1"></i> Add Item
                </button>
              </div>
              
              <div class="overflow-x-auto">
                <table class="table w-full">
                  <thead>
                    <tr>
                      <th class="w-1/2">Item</th>
                      <th>Quantity</th>
                      <th>Price</th>
                      <th>Total</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="items-container">
                    <tr class="item-row">
                      <td>
                        <input 
                          type="text" 
                          name="item_name[]" 
                          class="form-control item-name" 
                          placeholder="Item name"
                        >
                      </td>
                      <td>
                        <input 
                          type="number" 
                          name="item_quantity[]" 
                          class="form-control item-quantity" 
                          placeholder="Qty"
                          min="1"
                          value="1"
                        >
                      </td>
                      <td>
                        <input 
                          type="number" 
                          name="item_price[]" 
                          class="form-control item-price" 
                          placeholder="Price"
                          step="0.01"
                          min="0"
                        >
                      </td>
                      <td>
                        <input 
                          type="number" 
                          name="item_total[]" 
                          class="form-control item-total" 
                          placeholder="Total"
                          step="0.01"
                          min="0"
                          readonly
                        >
                      </td>
                      <td>
                        <button type="button" class="btn btn-outline btn-sm remove-item">
                          <i class="bi bi-trash"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- Notes -->
            <div class="mb-6">
              <label for="notes" class="block text-sm font-medium text-slate-700 mb-1">
                Notes
              </label>
              <textarea 
                id="notes" 
                class="form-control" 
                rows="3"
                placeholder="Additional notes for the customer"
              ></textarea>
            </div>
            
            <!-- Actions -->
            <div class="flex justify-end space-x-3">
              <button type="button" class="btn btn-outline" onclick="printInvoice()">
                <i class="bi bi-eye mr-2"></i>Preview
              </button>
              <button type="button" class="btn btn-primary">
                <i class="bi bi-send mr-2"></i>Create Invoice
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <!-- Invoice Preview -->
    <div class="lg:col-span-1">
      <div class="card sticky top-24">
        <div class="card-header">
          <h2 class="card-title">Invoice Preview</h2>
        </div>
        <div class="card-body">
          <div class="bg-white border border-slate-200 rounded-lg p-6">
            <div class="text-center mb-6">
              <div class="flex items-center justify-center mb-4">
                <div class="bg-slate-200 border-2 border-dashed rounded-xl w-16 h-16" />
              </div>
              <h3 class="text-xl font-bold">Digital Khata</h3>
              <p class="text-slate-600">123 Business Street, Delhi, India</p>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
              <div>
                <p class="text-sm text-slate-600">Invoice To</p>
                <p class="font-medium invoice-preview-customer">Select a customer</p>
                <p class="text-sm text-slate-600">Customer Address</p>
              </div>
              <div class="text-right">
                <p class="text-sm text-slate-600">Invoice #</p>
                <p class="font-medium">INV-00126</p>
                <p class="text-sm text-slate-600">Date: <span class="invoice-preview-date">{{ today }}</span></p>
                <p class="text-sm text-slate-600">Due: <span class="invoice-preview-due">-</span></p>
              </div>
            </div>
            
            <div class="border-t border-slate-200 pt-4 mb-6">
              <div class="invoice-preview-items">
                <!-- Items will be added here dynamically -->
              </div>
            </div>
            
            <div class="border-t border-slate-200 pt-4">
              <div class="flex justify-between mb-2">
                <span>Subtotal</span>
                <span class="invoice-preview-subtotal">₹0.00</span>
              </div>
              <div class="flex justify-between mb-2">
                <span>Tax (5%)</span>
                <span class="invoice-preview-tax">₹0.00</span>
              </div>
              <div class="flex justify-between font-bold text-lg pt-2">
                <span>Total</span>
                <span class="invoice-preview-total">₹0.00</span>
              </div>
            </div>
            
            <div class="mt-6 text-center">
              <button class="btn btn-primary w-full" onclick="shareViaWhatsApp()">
                <i class="bi bi-whatsapp mr-2"></i>Share via WhatsApp
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Add item row
    document.getElementById('add-item')?.addEventListener('click', function() {
      const container = document.getElementById('items-container');
      const newRow = document.createElement('tr');
      newRow.className = 'item-row';
      newRow.innerHTML = `
        <td>
          <input 
            type="text" 
            name="item_name[]" 
            class="form-control item-name" 
            placeholder="Item name"
          >
        </td>
        <td>
          <input 
            type="number" 
            name="item_quantity[]" 
            class="form-control item-quantity" 
            placeholder="Qty"
            min="1"
            value="1"
          >
        </td>
        <td>
          <input 
            type="number" 
            name="item_price[]" 
            class="form-control item-price" 
            placeholder="Price"
            step="0.01"
            min="0"
          >
        </td>
        <td>
          <input 
            type="number" 
            name="item_total[]" 
            class="form-control item-total" 
            placeholder="Total"
            step="0.01"
            min="0"
            readonly
          >
        </td>
        <td>
          <button type="button" class="btn btn-outline btn-sm remove-item">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      `;
      container.appendChild(newRow);
    });
    
    // Remove item row
    document.addEventListener('click', function(e) {
      if (e.target.closest('.remove-item')) {
        const row = e.target.closest('.item-row');
        if (document.querySelectorAll('.item-row').length > 1) {
          row.remove();
          calculateTotals();
        } else {
          // Clear the fields if it's the last row
          const inputs = row.querySelectorAll('input');
          inputs.forEach(input => input.value = '');
          calculateTotals();
        }
      }
    });
    
    // Calculate item total when quantity or price changes
    document.addEventListener('input', function(e) {
      if (e.target.classList.contains('item-quantity') || e.target.classList.contains('item-price')) {
        const row = e.target.closest('.item-row');
        const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
        const price = parseFloat(row.querySelector('.item-price').value) || 0;
        const total = quantity * price;
        row.querySelector('.item-total').value = total.toFixed(2);
        calculateTotals();
      }
    });
    
    // Calculate totals
    function calculateTotals() {
      let subtotal = 0;
      const totals = document.querySelectorAll('.item-total');
      totals.forEach(total => {
        subtotal += parseFloat(total.value) || 0;
      });
      
      const tax = subtotal * 0.05;
      const discount = 0;
      const total = subtotal + tax - discount;
      
      // Update preview
      document.querySelector('.invoice-preview-subtotal').textContent = '₹' + subtotal.toFixed(2);
      document.querySelector('.invoice-preview-tax').textContent = '₹' + tax.toFixed(2);
      document.querySelector('.invoice-preview-total').textContent = '₹' + total.toFixed(2);
    }
  });
</script>
{% endblock %}